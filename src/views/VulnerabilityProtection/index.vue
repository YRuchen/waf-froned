<script setup lang="tsx">
import { ContentWrap } from '@/components/ContentWrap'
import { onMounted, ref } from 'vue'
import {
  ElSelect,
  ElOption,
  ElTabs,
  ElTabPane,
  ElSwitch,
  ElDialog,
  ElButton,
  ElIcon,
  ElMessage,
  ElRadioGroup,
  ElRadio,
  ElTable,
  ElTableColumn,
  ElTooltip
} from 'element-plus'
import type { TabsPaneContext } from 'element-plus'
import level1 from '@/assets/imgs/level1.png'
import level2 from '@/assets/imgs/level2.png'
import level3 from '@/assets/imgs/level3.png'
import level4 from '@/assets/imgs/level4.png'
import { WarningFilled } from '@element-plus/icons-vue'
import {
  getTableListApi,
  getCorazaApi,
  putCorazaApi,
  getCategoriesApi
} from '@/api/vulnerabilityProtection'
import { CorazaParams, ACTION, PARANOIA_LEVEL, STATUS } from '@/api/vulnerabilityProtection/types'
import { useRouter } from 'vue-router'
const { push } = useRouter()
const options = ref<Array<CorazaParams>>([])
const levelOptions = [
  {
    key: PARANOIA_LEVEL.VERY_STRICT,
    title: '非常严格',
    content:
      '包含对未知威胁和极隐蔽攻击的深度检测规则，非常严格等级下会启用所有规则等级（宽松、正常、严格及非常严格），并提供额外的语义分析和异常检测能力',
    img: level1
  },
  {
    key: PARANOIA_LEVEL.STRICT,
    title: '严格',
    content: '包含对复杂攻击的检测规则，严格等级下会包含所有规则等级为宽松、正常及严格的规则',
    img: level1
  },
  {
    key: PARANOIA_LEVEL.NORMAL,
    title: '正常',
    content:
      '包含某类攻击的通用检测规则或误报较少的规则，正常等级时会包含所有规则等级为宽松及正常的规则',
    img: level2
  },
  {
    key: PARANOIA_LEVEL.LOOSE,
    title: '宽松',
    content:
      '适用于防护攻击特征较为明显的请求及其他防护等级下误报较多的场景，包含所有规则等级为宽松的规则',
    img: level3
  }
]
const activeName = ref('first')
interface User {
  ruleType: string
  desc: string
  subCategory?: User[]
}
const tableData = ref<Array<User>>([])
const handleClick = (tab: TabsPaneContext, event: Event) => {
  console.log(tab, event)
}
const queryForm = ref<CorazaParams>({
  domainName: '',
  status: STATUS.OFF,
  action: ACTION.BLOCK,
  paranoiaLevel: PARANOIA_LEVEL.VERY_STRICT
})
const nextStatus = ref<any>()
const dialogVisible = ref(false)
const switchDialogVisible = ref(false)
let resolveFn: (val: boolean) => void
// 修改防护等级弹窗
const handleClickLevel = (key: PARANOIA_LEVEL) => {
  if (queryForm.value.paranoiaLevel === key) return
  dialogVisible.value = true
  nextStatus.value = key
}
const handleConfirm = async () => {
  dialogVisible.value = false
  await putCorazaApi({ ...queryForm.value, paranoiaLevel: nextStatus.value })
  ElMessage.success('修改成功')
  getCoraza()
}
// switch 切换前触发，返回 true 才会改变开关
const handleBeforeChange = () => {
  return new Promise<boolean>((resolve) => {
    switchDialogVisible.value = true
    nextStatus.value = queryForm.value.status == STATUS.OPEN ? STATUS.OFF : STATUS.OPEN
    resolveFn = resolve
    ElMessage.closeAll()
  })
}
const handleConfirmSwitch = async () => {
  switchDialogVisible.value = false
  const actionText = nextStatus.value == STATUS.OFF ? '关闭' : '开启'
  await putCorazaApi({ ...queryForm.value, status: nextStatus.value })
  getCoraza()
  ElMessage.success({
    message: `${actionText}${queryForm.value.status == nextStatus.value ? '失败' : '成功'}`
  })
  resolveFn(true) // 允许切换
}
/**获取防护类型列表 */
const getCategories = async () => {
  const res = await getCategoriesApi({ domain: queryForm.value.domainName })
  tableData.value = res.data.categories
}
const handleChangeAction = async () => {
  await putCorazaApi(queryForm.value)
  getCoraza()
}

/**获取源站 */
const getTableList = async () => {
  const res = await getTableListApi({
    page: 1,
    pageSize: 1000
  })
  options.value = res.data.domains?.map((item) => ({ domainName: item.hostname })) ?? []
  queryForm.value.domainName = options.value.length > 0 ? options.value[0].domainName : ''
  getCoraza()
}

/**获取漏洞信息 */
const getCoraza = async () => {
  const res = await getCorazaApi({ domainName: queryForm.value.domainName })
  queryForm.value = res.data
  getCategories()
}
onMounted(() => {
  getTableList()
})
</script>

<template>
  <ContentWrap v-if="queryForm.domainName" class="!abc123pt-0">
    <div class="page-title">选择域名</div>
    <div class="bottom-10">
      <p class="form-lable">域名</p>
      <ElSelect v-model="queryForm.domainName" style="width: 240px" @change="getCoraza">
        <ElOption
          v-for="item in options"
          :key="item.domainName"
          :label="item.domainName"
          :value="item.domainName"
        >
          <span>{{ item.domainName }}</span>
        </ElOption>
      </ElSelect>
    </div>
    <div class="page-title-second">配置防护策略</div>
    <el-tabs v-model="activeName" type="card" class="demo-tabs" @tab-click="handleClick">
      <el-tab-pane label="漏洞防护" name="first">
        <div class="flex items-center">
          <span class="page-title-third"> 漏洞防护 </span>
          <el-switch
            v-model="queryForm.status"
            :before-change="handleBeforeChange"
            active-value="PLUGIN_STATUS_ON"
            inactive-value="PLUGIN_STATUS_OFF"
          />
          <ElTooltip
            effect="dark"
            content="开关仅对当前所选域名生效，其他域名规则不受影响。"
            placement="top"
          >
            <Icon icon="ep:warning" class="ml-3" />
          </ElTooltip>
          <span class="page-info"
            >对常见的Web应用攻击，如SQL注入、XSS攻击、网页挂马等提供安全防护能力。</span
          ></div
        >
        <ul class="ul-continer">
          <li
            v-for="item in levelOptions"
            :key="item.key"
            :class="{ active: queryForm.paranoiaLevel === item.key }"
            @click="handleClickLevel(item.key)"
          >
            <img :src="item.img" alt="" />
            <div
              ><p>{{ item.title }}</p>
              <span>{{ item.content }}</span>
            </div>
          </li>
        </ul>
        <div
          ><span class="page-title-third">扫描防护</span>
          <span class="page-info-second"
            >适用于信息收集、后台扫描、漏洞扫描场景下对攻击源的检测与封禁</span
          ></div
        >
        <div
          ><span class="page-title-third">防护动作：</span
          ><el-radio-group v-model="queryForm.action" @change="handleChangeAction">
            <el-radio value="CORAZA_ACTION_OBSERVE" size="large">观察</el-radio>
            <el-radio value="CORAZA_ACTION_BLOCK" size="large">拦截</el-radio>
          </el-radio-group></div
        >
        <el-table
          :data="tableData"
          style="width: 100%; margin: 20px 0"
          row-key="ruleType"
          :tree-props="{ children: 'subCategory' }"
          border
        >
          <el-table-column prop="ruleType" label="防护类型" width="250" />
          <el-table-column prop="desc" label="规则描述" />
          <!-- <el-table-column prop="number" label="规则数" width="100" /> -->
        </el-table>
      </el-tab-pane>
    </el-tabs>
    <!-- 更改防护等级弹框 -->
    <el-dialog v-model="dialogVisible" width="600">
      <template #header>
        <el-icon style="margin-right: 6px; color: #e6a23c" :size="20">
          <WarningFilled />
        </el-icon>
        更改防护等级确认
      </template>
      <span>更改防护等级后将会立即生效，请谨慎操作</span>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="dialogVisible = false">取消</el-button>
          <el-button type="primary" @click="handleConfirm"> 确定 </el-button>
        </div>
      </template>
    </el-dialog>
    <!-- 更改漏洞防护开关状态弹框 -->
    <el-dialog v-model="switchDialogVisible" width="600">
      <template #header>
        <el-icon style="margin-right: 6px; color: #e6a23c" :size="20">
          <WarningFilled />
        </el-icon>
        更改功能开关确认
      </template>
      <span>更改防护策略功能开关后将会立即生效，请谨慎操作</span>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="switchDialogVisible = false">取消</el-button>
          <el-button type="primary" @click="handleConfirmSwitch"> 确定 </el-button>
        </div>
      </template>
    </el-dialog>
  </ContentWrap>
  <ContentWrap class="flex items-center justify-center text-center h-screen" v-else>
    <Icon icon="vi-ep:warning-filled" class="!text-[var(--el-color-warning)]" :size="80"></Icon>
    <h3 class="my-3">暂无相关数据</h3>
    <p class="my-3">您还没有接入任何数据，请接入网络后查看网站设置信息</p>
    <ElButton type="primary" @click="push('/websiteSettings/index')">新建站点</ElButton>
  </ContentWrap>
</template>

<style lang="less" scoped>
.el-button {
  margin-top: 10px;
}
.page-title {
  font-size: 18px;
  line-height: 26px;
  color: #0c0d0e;
  margin-bottom: 20px;
}
.form-lable {
  font-size: 13px;
  color: #42464e;
  display: inline-block;
  margin-right: 10px;
}
.bottom-10 {
  margin-bottom: 10px;
}
.page-title-second {
  font-size: 18px;
  margin: 40px 0 10px;
}
.page-title-third {
  font-size: 14px;
  margin-right: 16px;
}
.page-info {
  color: #42464e;
  margin-left: 20px;
}
.page-info-second {
  color: #42464e;
}
.ul-continer {
  display: flex;
  justify-content: space-around;
  margin: 20px 0;
  li {
    width: 20%;
    display: flex;
    flex: 1 1;
    -moz-box-align: center;
    align-items: center;
    border: 1px solid #eaedf1;
    border-radius: 4px;
    cursor: pointer;
    padding: 12px 16px;
    -moz-transition: all 0.1s linear;
    transition: all 0.1s linear;
    margin: 0 10px;
    &:hover {
      border: 1px solid #4e83ff;
    }
    img {
      width: 28px;
      margin-right: 16px;
    }
    p {
      color: #0c0d0e;
      margin-bottom: 6px;
      font-size: 14px;
    }
    span {
      color: #42464e;
      font-size: 12px;
    }
  }
  .active {
    border: 1px solid #4e83ff;
  }
}
</style>
